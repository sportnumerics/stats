Fn::Sub:
  - |- 
    {
      "Comment": "Orchestration for collecting stats",
      "StartAt": "CollectAllTeamsForReduction",
      "States": {
        "CollectAllTeamsForReduction": {
          "Type": "Task",
          "Resource": "${collectAllForReductionArn}",
          "Next": "ReduceTeams"
        },
        "ReduceTeams": {
          "Type": "Task",
          "Resource": "${reduceTeamsArn}",
          "Next": "Check"
        },
        "Check": {
          "Type": "Choice",
          "Choices": [
            {
              "Variable": "$.done",
              "BooleanEquals": true,
              "Next": "NormalizeTeams"
            }
          ],
          "Default": "ReduceTeams"
        },
        "NormalizeTeams": {
          "Type": "Task",
          "Resource": "${normalizeTeamsArn}",
          "Next": "TriggerPrediction"
        },
        "TriggerPrediction": {
          "Type": "Task",
          "Resource": "${predictArn}",
          "Next": "Success"
        },
        "Success": {
          "Type": "Succeed"
        }
      }
    }
  - collectAllForReductionArn: 
      Fn::GetAtt: [CollectAllTeamsForReductionLambdaFunction, Arn]
    reduceTeamsArn:
      Fn::GetAtt: [ReduceTeamsLambdaFunction, Arn]
    normalizeTeamsArn:
      Fn::GetAtt: [NormalizeTeamsLambdaFunction, Arn]
    predictArn: ${{file(serverless.yml):custom.predictLambdaArn}}