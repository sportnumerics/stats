Resources:
  TeamsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: year
          AttributeType: S
        - AttributeName: div
          AttributeType: S
      KeySchema:
        - AttributeName: year
          KeyType: HASH
        - AttributeName: id
          KeyType: RANGE
      LocalSecondaryIndexes:
        - IndexName: by_div
          KeySchema:
            - AttributeName: year
              KeyType: HASH
            - AttributeName: div
              KeyType: RANGE
          Projection:
            NonKeyAttributes:
              - name
              - schedule
              - ratings
            ProjectionType: INCLUDE
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 20
      TableName: ${{file(serverless.yml):custom.teamsTableName}}
  DivisionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: year
          AttributeType: S
      KeySchema:
        - AttributeName: year
          KeyType: HASH
        - AttributeName: id
          KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      TableName: ${{file(serverless.yml):custom.divisionsTableName}}
  StateMachineSchedule:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: rate(1 hour)
      Targets:
        - Id: StateMachineTarget
          Arn:
            Ref: StateMachine
          RoleArn:
            Fn::GetAtt: [StateMachineScheduleRole, Arn]
  StateMachineScheduleRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: StateMachineSchedulePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: "states:StartExecution"
                Resource:
                  Ref: StateMachine
  StateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      DefinitionString: ${{file(state-machine.yml)}}
      RoleArn:
        Fn::GetAtt: [StateMachineRole, Arn]
  StateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - Fn::Join:
                  - "."
                  - - states
                    - Ref: AWS::Region
                    - amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: StateMachinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: "lambda:InvokeFunction"
                Resource:
                  - Fn::GetAtt: [CollectAllTeamsForReductionLambdaFunction, Arn]
                  - Fn::GetAtt: [ReduceTeamsLambdaFunction, Arn]
                  - Fn::GetAtt: [NormalizeTeamsLambdaFunction, Arn]
                  - ${{file(serverless.yml):custom.predictLambdaArn}}
  PendingTeamsQueue:
    Type: AWS::SQS::Queue

Outputs:
  DivsTableName:
    Description: Divs table name in DynamoDB
    Value:
      Ref: DivisionsTable
  TeamsTableName:
    Description: Teams table name in DynamoDB
    Value:
      Ref: TeamsTable
